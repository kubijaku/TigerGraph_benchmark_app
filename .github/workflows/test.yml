name: TigerGraph Query Performance Test

on:
    workflow_dispatch:

jobs:
    performance-test:
        runs-on: ubuntu-latest

        steps:
        #   - name: Checkout
        #     uses: actions/checkout@v4
        #     with:
        #       lfs: true
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Create LFS file list
            run: git lfs ls-files -l | cut -d' ' -f1 | sort > .lfs-assets-id

          - name: Restore LFS cache
            uses: actions/cache@v4
            id: lfs-cache
            with:
                path: .git/lfs
                key: ${{ runner.os }}-lfs-${{ hashFiles('.lfs-assets-id') }}-v1

          - name: Git LFS Pull
            run: git lfs pull

          - name: Start TigerGraph container
            run: |
                docker run -d --name tigergraph \
                -p 14022:14022 \
                -p 9000:9000 \
                -v $PWD/initialization:/home/tigergraph/mydata \
                -v $PWD/queries:/home/tigergraph/queries \
                -v $PWD/test1:/home/tigergraph/test1 \
                tigergraph/community:4.2.2
          - name: Start TigerGraph services inside container
            run: |
                echo "Initializing TigerGraph with gadmin..."
                docker exec tigergraph bash -c \
                    "./tigergraph/app/cmd/gadmin start all"
        
          - name: Print head of cskg file
            run: |
                docker exec tigergraph bash -c \
                    "head -n 5 /home/tigergraph/mydata/cskg.tsv"
        
          - name : Check gadmin status
            run: |
                docker exec tigergraph bash -c \
                    "./tigergraph/app/cmd/gadmin status gsql"
          - name: Wait for TigerGraph to be ready
            run: |
                echo "Waiting for TigerGraph to be ready..."
                sleep 10
                echo "TigerGraph is ready."
          - name : Check gadmin status
            run: |
                docker exec tigergraph bash -c \
                    "./tigergraph/app/cmd/gadmin status gsql"
                
          - name: Run init script
            run: |
                docker exec tigergraph bash -c \
                    "source /home/tigergraph/.bashrc && ./tigergraph/app/cmd/gsql < /home/tigergraph/mydata/import.gsql"
          - name: Add query01 to TigerGraph
            run: |
                docker exec tigergraph bash -c \
                    "source /home/tigergraph/.bashrc && ./tigergraph/app/cmd/gsql < /home/tigergraph/queries/query_01.gsql"
                
          - name: Run query01 on sample-nodes.csv and collect metrics
            id: metrics
            run: |
              set -eu pipefail
              echo "Running query_01 for all IDs in sample-nodes.csv"
              START_TIME=$(date +%s)
              CSV="/home/tigergraph/test1/sample_nodes.csv"
              tail -n +2 "\$CSV" | cut -d"," -f1 | while IFS= read -r ID; do
                  ./tigergraph/app/cmd/gsql "USE GRAPH ADS RUN QUERY query_01(\"\$ID\")" > /dev/null
              done
              EOF
              2>&1)
              END_TIME=$(date +%s)
              TOTAL_TIME=$((END_TIME - START_TIME))
              PEAK_MEM=$(echo "$OUTPUT" | grep 'Maximum resident set size' | awk '{print $6}')
              echo "Total execution time: $TOTAL_TIME seconds"
              echo "Peak memory usage   : $PEAK_MEM KB"
              echo "final_time=$TOTAL_TIME" >> "$GITHUB_OUTPUT"
              echo "final_memory=$PEAK_MEM" >> "$GITHUB_OUTPUT"
          - name: Display results
            run: |
                echo "Final measured time   : ${{ steps.metrics.outputs.final_time }}"
                echo "Final measured memory : ${{ steps.metrics.outputs.final_memory }} KB"